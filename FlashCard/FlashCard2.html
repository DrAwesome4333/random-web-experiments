<!DOCTYPE html>
<html>
    <head>
        <link rel="icon" 
        type="image/x-icon" 
        href="https://drawesome4333.github.io/favicon.ico">
        <title>Flash Card</title>
        <style>
            body{
                text-align:center;
            }
            h1{
                text-align:center;
            }
            .hidden{
                display:none;
            }
            .question_count{
                position:absolute;
                left:0px;
                top:0px;
            }
            .quiz_score{
                position: absolute;
                right:0px;
                top:0px;
            }
            .card{
                border:2px black solid;
            }
            .correct{
                border:2px green solid;
            }
            .incorrect{
                border:2px red solid;
            }
            .quiz_button{
                outline:none;
            }
            input{
                outline:none;
            }
            .selected{
                border:2px blue solid;
            }
        </style>
    </head>
    <body>
        <div id="Home">
            <!--Home page, the buttons will be create a deck or select a deck-->
            <h1>Flash Card</h1>
            <h2>Please select an option</h2>
            <input type="button" value="Deck Selcetion" onclick="hide(this.parentNode);show(document.getElementById('DeckSelect'));">
            <input type="button" value="Create a Deck" onclick="hide(this.parentNode);show(document.getElementById('CreateHome'));">
        </div>
        <div id="DeckSelect" class = "hidden">
            <!--This is where you will select a deck to start -->
            <h1>Flash Card</h1>
            <h2>Select a Deck</h2>
            <div id = "DeckSelector">
                (No Decks Available, try uploading one)
            </div>
            <input type="file" id="FileUpload" value="Upload a deck" onchange = "Data.LoadDecks(this.files[0])" class="hidden">
            <input type="button" id="UploadDeck" value = "Upload a deck" onclick="var eve=new MouseEvent('click');Data.FileElement.dispatchEvent(eve)">
            <input type="button" id="QuizMode" value="Quiz Mode" onclick="if(Quiz.SelectedDeck!=-1/*TODO Put permision verification here*/){hide(this.parentNode);show(document.getElementById('Quiz'));Quiz.StartQuiz(0)}else{
                alert('Please select a deck to use!');
            }" >
            <input type="button" id ="PracticeMode" disabled =true value="Practice Mode">
            <input type="button" id="PracticeQuizMode" disabled=true value="Practice Quiz Mode"><br>
            <input type="button" value="Back" onclick="hide(this.parentNode);show(document.getElementById('Home'));">
        </div>

        <div id="Quiz" class = "hidden">
            <!--Where the quiz will be displayed-->
            <h1 id="QuizTitle">Quiz Title</h1>
            <h3 id="QuestionCount" class="question_count">Question -- of --</h3>
            <h3 id="Score" class="quiz_score">--%</h3>
            <div id="Card"></div>
            <input type="button" id = "QuizPrev" onclick = "Quiz.PreviousQuestion();" value="Previous Question">
            <input type="button" id= "QuizNext" onclick = "Quiz.NextQuestion();" value="Next">
            <input type="button" value="Quit" onclick="var conf = confirm('Are you sure you want to quit?');if(conf){hide(this.parentNode);show(document.getElementById('DeckSelect'));}">
        </div>

        <div id="Review" class = "hidden">

        </div>

        <div id="CreateHome" class = "hidden">
            <h1>Create Your Own Deck</h1>
            <h2>Please select an option</h2>
            <!--This is where you can select to edit a previously started deck or start from scratch-->
            <input type="button" value="Create New">
            <input type="button" value="Continue/Edit">
            <br>
            <input type="button" value="Back" onclick="hide(this.parentNode);show(document.getElementById('Home'));">
        </div>
        <script>
            "use strict";
            //Show a hidden HTML element
            function show(ele){
                ele.style.display="block";
            }
            //Hide an HTML element
            function hide(ele){
                ele.style.display="none";
            }
            
            //creates a Card object. One is made for every question, it contains all HTML Elements
            //and information about a card. 
            function Card(deck = 0, questionId = 0, cardNumber = Quiz.Cards.length){
                this.card = document.createElement("DIV");
                this.card.classList.add("card");
                this.canvas = document.createElement("Canvas");//used for hint timer
                this.ct = this.canvas.getContext('2d');
                this.title = document.createElement("DIV");
                this.title.classList.add("quiz_title");
                this.hint = document.createElement("DIV");
                this.hint.classList.add("hint");
                this.tryHint = document.createElement("DIV");
                this.tryHint.classList.add("tryHint");
                this.inputs = [];//keeps track of various input elements such as buttons and checkboxes
                                 // used in different ways for different question types
                this.attempt = 0;//The number of times the question has been answered
                this.maxAttempts = 1;//How many trys are allowed
                this.hintText = "";//The text of the auto hint that showes up
                this.tryHintText = "";//The text that showes up after the question was answered incorrectly
                this.hintTime = 1;//The total amount of delay the timer will wait before displaying the hint
                this.hintEnd = 0;//The UTC time the hint timer ends and will show the hint
                this.hintBegin = 0;//What time the hint timer began
                this.updateInterval = 0;//Used to store the ID of the interval that updates the hint timer
                                        // so it can be cleared later
                this.questionType = "";//Identifies the type of question that is on the card
                this.possiblePoints = 0;//The maximum points that can be earned from this card
                this.pointsPerAnswer = 0;//How many points each answer can give (can vary based on the type of question)
                this.earnedPoints = 0;//How many points were earned after answering the question (used in reviews)
                this.answer =-1;//The answer to the question, used in various ways by various question types:
                                /* MultipleChoice - the id of the correct button is stored here ex: q4a2
                                *  TextEntry - the possible answers are stored here ["Answer","Answer."]
                                *  SelectAll - an array of true/false values is stored that match up with
                                *    the first checkbox elements in the input array. [true,false,true]
                                */
                this.started = false;//Used to determine if the card has been started before and should run its start code
                this.valid = true;//Set to false if there was a problem loading the question data to allow the user to skip the question
                this.caseSenstive = false;//Used to tell if TextEntry questions are case sensitive
                this.acceptPartial = false;//Used to tell us if partial credit should be given to partialy correct answers in SelectAll types

                this.card.appendChild(this.title);
                //Put the card in the card holder on the page and start hint the timer
                this.show = function(){
                    //Append the card element to the card holder
                    Quiz.CardElement.appendChild(this.card);
                    //If we have not yet, start the hint timer. We do not want to do this again if we are just showing the card again
                    if(!this.started){
                        //Check to see if there is text to be started
                        if(this.hintText != "" ){
                            this.hintBegin = Date.now();
                            this.hintEnd = this.hintBegin + this.hintTime * 1000;
                            this.updateInterval = setInterval(this.hintUpdate,100,this);
                        }
                        Quiz.NextButton.disabled = true;
                        this.started = true;
                    }
                    //Unlock the next button if there was a problem with loading the card
                    //TODO add skip for already answered questions aswell
                    if(!this.valid){
                        Quiz.NextButton.disabled = false;
                    }
                }
                //Function ran by the hint interval
                //Updates the timer and the animation
                //Will show the hint when the timer expires
                this.hintUpdate = function(card){
                    //Use the percentage to draw a timer
                    var percent = ( card.hintEnd - Date.now() ) / ( card.hintTime * 1000 );
                    //Check to see if we have hit the end of the timer
                    if(percent <= 0){
                        //if it is below 0, set it to 0 to prevent odd graphics from circle timer
                        percent = 0;
                        clearInterval(card.updateInterval);
                        //show the hidden hint element
                        show(card.hint);
                    }

                   card.ct.clearRect(0, 0, 30, 30);
                   //Draw the background circle
                   card.ct.beginPath();
                   card.ct.arc(15, 15, 15, 0, 2 * Math.PI);
                   card.ct.fillStyle = "#AAAAAA";
                   card.ct.fill();
                   //Draw the partial circle
                   card.ct.beginPath();
                   card.ct.moveTo(15, 15);
                   //start from the top and go clockwise to the end of the circle wedge
                   card.ct.arc(15, 15, 15, 1.5 * Math.PI, 1.5 * Math.PI + (percent * 2 * Math.PI))
                   card.ct.fillStyle="#333333";
                   card.ct.fill();
                }
                //Checks the answer, the parameter is the id of the element that sent it.
                /* Different question types use it differently
                 * MultipleChoice if the answer id is the same as this.answer then the correct answer was selected
                 * TextEntry the answer id is mostly ignored by the card as it is the Id of the "Check answer" button
                 *  Instead we will check the possible answers in this.answer against the vale in the first element in this.inputs
                 *  as that is the input text element where the answer is given.
                 * SelectAll also mostly ignores it and instead checks each of the input elements minus the last one (as it is the
                 *  "Check answer" button) to see if the checked value matches that of the same index of this.answer[]
                */
                this.checkAnswer = function(answer){
                    //as most question types check answers differently we just use a switch statement
                    //Maybe use different classes in stead?
                    switch(this.type){
                        case ("MultipleChoice"):{
                            //Check if the button's id matches that of the correct answer
                            if(answer == this.answer){
                                //Mark the button as correct and disable the answer buttons
                                document.getElementById(this.answer).classList.add("correct");
                                this.inputs.forEach(input =>{
                                   input.disabled = true;//disable all answer buttons
                                 })
                                 //Calculate points and enable the Next button
                                 Quiz.EarnedPoints += this.possiblePoints;
                                 Quiz.TotalPoints += this.possiblePoints;
                                 this.earnedPoints = this.possiblePoints;

                                 Quiz.NextButton.disabled = false;
                            }else{
                                this.attempt++;
                                //Disable and mark the incorrect answer button tried and show the try hint
                                document.getElementById(answer).classList.add("incorrect");
                                document.getElementById(answer).disabled = true;
                                show(this.tryHint);
                                //See if the attempt limit has been reached, if so disable the rest of the buttons
                                //and calculate the points and then enable the next button
                                if(this.attempt >= this.maxAttempts){
                                    this.inputs.forEach(input =>{
                                        input.disabled = true;//disable all answer buttons
                                    })
                                   
                                    Quiz.TotalPoints += this.possiblePoints;
                                    this.earnedPoints = 0;

                                    Quiz.NextButton.disabled = false;
                                } 
                            }
                            break;
                        }
                        case ("TextEntry"):{
                            //We are going to check if the input given in the text box (this.inputs[0].value)
                            //Matches any of the values stored in this.answer
                            var correct = false;//if any of the values in this.answer match the input this will be set to true
                            var inputText = this.inputs[0].value.trim();

                            //Set the input to lower case if we are not checking for case
                            if(!this.caseSenstive){
                                inputText = inputText.toLowerCase();
                            }

                            //Compare the input to all values stored in this.answer and stop when we find a match
                            for(var i = 0;i<this.answer.length;i++){
                                //Check answer values in lower case if we are not checking for case
                                //else check without setting the answers to lower case
                                if(!this.caseSenstive){
                                    if(inputText === this.answer[i].trim().toLowerCase()){
                                        correct = true;
                                        break;
                                    }
                                }else{
                                    if(inputText === this.answer[i].trim()){
                                        correct = true;
                                        break;
                                    } 
                                }
                            }
                            //if one of the values in this.answer match the input
                            if(correct){
                                //remove the incorrect class if one was added in a prior attempt and add
                                //the correct class then disable the inputs
                                document.getElementById(answer).classList.remove("incorrect");
                                document.getElementById(answer).classList.add("correct");
                                this.inputs.forEach(input =>{
                                    input.disabled = true;//disable the inputs
                                })

                                //Calcuate the points and enable the Next button
                                Quiz.EarnedPoints += this.possiblePoints;
                                Quiz.TotalPoints += this.possiblePoints;
                                this.earnedPoints = this.possiblePoints;
                                Quiz.NextButton.disabled = false;
                            }else{
                                //The input did not match an answer so mark the button as incorrect
                                // and show the try hint
                                this.attempt++;
                                document.getElementById(answer).classList.add("incorrect");
                                this.tryHint.style.display = "block";

                                //Check to see this was the last attempt, if so disable
                                //the inputs and enable the next button and calculate the points
                                if(this.attempt >= this.maxAttempts){
                                    this.inputs.forEach(input =>{
                                        input.disabled = true;//disable all inputs
                                    })
                                    
                                    //Calculate points and denable the next button
                                    Quiz.TotalPoints += this.possiblePoints;
                                    this.earnedPoints = 0;
                                    Quiz.NextButton.disabled = false;
                                } 
                            }
                            break;
                        }
                        case ("SelectAll"):{
                            // Here we are going to check the values of the checkbox inputs against our answer array
                            
                           var finalAttempt = this.attempt + 1 >= this.maxAttempts;//To know if we should mark boxes correct or incorrect in this run
                                                                                    //We only want to reveal the answers on the final attempt
                           var numberCorrect = 0;//This will act is a sort of point counter, for each
                                                 // box checked correctly a point is added, if it was checked in error a point is subtracted
                           var perfect = 0;//if all the check boxes are checked correctly, then numberCorrect will match this value
                           //Loop through all answer values to see how many total boxes should be checked
                           //Remember the answer format for this question is [true, false, true, true...]
                           this.answer.forEach(ans=> {
                               //Check if ans is true or false, if true, add one to the perfect counter
                               if(ans){
                                   perfect++;
                               }
                           });
                           //Go through each of the inputs in this.inputs minus the last one as it is the Check Answer button
                           //and see if they match the correlating value in this.answer
                           for(var i = 0;i<this.inputs.length-1;i++){
                               //If the answer says it should be checked:
                               if(this.answer[i]){
                                   //If it is checked then it is correct and should be marked if such if we are on the final attempt
                                    if(this.inputs[i].checked){
                                        numberCorrect++;
                                        if(finalAttempt){
                                            this.inputs[i].parentNode.classList.add("correct")
                                        }
                                    }else{
                                        //if it was not checked mark it wrong if this is the final attempt to show the user
                                        //that it should have been checked
                                        if(finalAttempt){
                                            this.inputs[i].parentNode.classList.add("incorrect")
                                        }
                                    }
                               }else{
                                    //Check to see if the answer was checked when it should not have been
                                    //if so take away points so that even if all the other correct answers are checked
                                    //you will not get the question correct. This is used to calcuate partial points if it is
                                    //enabled by the question. Then mark the box as incoreect
                                     if(this.inputs[i].checked){
                                        numberCorrect--;
                                        if(finalAttempt){
                                            this.inputs[i].parentNode.classList.add("incorrect")
                                        }
                                    }
                               }
                           }
                           //See if we got everything correct, if so remove the incorrect class from the 
                           //check answer button (the final element in the array which can be identified
                           //by the length of this.answer because this.answer should have 1 less element
                           //than this.inputs. We remove the class because it could have been added
                           //in previous attempts. Then we add the correct class to the button and all
                           //correctly checked boxes if it was not done before as this may be the first attempt
                            if(numberCorrect == perfect){
                                this.inputs[this.answer.length].classList.remove("incorrect");
                                this.inputs[this.answer.length].classList.add("correct");
                                for(var i = 0;i<this.inputs.length-1;i++){
                                     if(this.answer[i]){
                                        this.inputs[i].parentNode.classList.add("correct")              
                                    }
                                }
                                this.inputs.forEach(input =>{
                                input.disabled = true;//disable all the inputs
                                })

                                //calculate the points
                                Quiz.EarnedPoints+=this.possiblePoints;
                                Quiz.TotalPoints+=this.possiblePoints;
                                this.earnedPoints = this.possiblePoints;

                                //enable the next button
                                Quiz.NextButton.disabled = false;
                            }else{
                                //The answer given was not perfect so mark the check answer button with
                                //the incorrect class and incease the attempt counter and display the try hint
                                this.attempt++;
                                this.inputs[this.answer.length].classList.add("incorrect");
                                this.tryHint.style.display = "block";
                                //if this was the last attempt disable all the inputs (they should already have)
                                //the correct and incorrect classes applied
                                if(this.attempt >= this.maxAttempts){
                                    this.inputs.forEach(input =>{//disable all answers
                                        input.disabled = true;
                                    })
                                    //Calculate points and add any partial points in as well
                                    Quiz.TotalPoints+=this.possiblePoints;
                                    if(this.acceptPartial){
                                        this.earnedPoints = this.pointsPerAnswer*numberCorrect;
                                        Quiz.EarnedPoints += this.earnedPoints;
                                    }
                                    //enable the next button
                                    Quiz.NextButton.disabled = false;
                                } 
                            }
                            break;
                        }
                       
                        default:{
                            //If the somehow got here, something happened so just enable the next button for 'em
                            this.title.innerHTML = "An error occurred, so just go ahead and hit next, sorry no points :("
                            Quiz.NextButton.disabled = false;
                        }
                    }
                }
                //Atempt to load the question, this may produce an error so be ready 
                //to catch it just in case the question does not exist.
                var question = null;
                try{
                    question = Data.Decks[deck].Questions[questionId];
                }catch(e){
                    alert("Error:\nQuestion "+questionId+" does not exist.\nPlease contact the creator of the deck.");
                    return;
                }

                // If the question loaded without too many problems, proceed to set up the card
                this.type = question.Type;

                //How the card is put together changes based on what type it is.
                switch(this.type){
                    case("MultipleChoice"):{
                        //Start by loading up the extra answers that we will mix our 
                        //true answer with
                        //We start by getting the extras that are specified for the question
                        var extras = [];
                        var answerText = question.Answers[0] + "";//We will use this to make sure none of our extras will match the answer text
                         //load extras from question
                         //We will avoid altering the original question object so we must copy the elements one by one
                         for(var i = 0; i < question.Extras.length; i++){
                             extras.push(question.Extras[i]);
                         }
                        
                        //We will now start pulling extra answers from the extra banks and mix them with our other extras
                        var neededExtras = question.NumberOfExtras - extras.length;//The number of extras we are going to need
                        if(neededExtras > 0){
                            //To select our extras we will put all the possibles in a list from all the available
                            //banks ascociated with this question and then randomly select them from this list
                            var possibleExtras = [];
                            var banks = question.Banks;//to simplify asking form banks we assign question.Banks to banks so we don't
                                                    //have to type question.banks
                            //Loop through all the banks in this quiz
                            for(var i = 0;i < Quiz.Banks.length; i++){
                                //Loop through all the banks in the question
                                for(var j = 0;j < banks.length; j++){
                                    //to find all the banks that this question has
                                    if(Quiz.Banks[i].Name == banks[j]){
                                        //put all the extras in to the possible extras if they do not match the answer's text
                                        for(var k = 0; k < Quiz.Banks[i].Extras.length; k++){
                                            if(Quiz.Banks[i].Extras[k] + "" != answerText)
                                                possibleExtras.push(Quiz.Banks[i].Extras[k]);
                                        }
                                    }
                                }
                            }

                            //Now while we still need more extras in the extras array we will
                            //select a random extra from possible extras, we also need to make sure
                            //there are still possibleExtras we check its length just in case
                            //there is not enough to fill the number needed to match the question's request
                            while(neededExtras > 0 && possibleExtras.length > 0){
                                //Select a random index in the possible extras array
                                var newExtra = Math.floor(Math.random() * possibleExtras.length);
                                //Next we need to check for duplicate answers
                                var isValid = true;
                                for(var i = 0;i < extras.length && isValid; i++){
                                    //check to see if the current selection matches any we already have in the extra array
                                    if(extras[i] == possibleExtras[newExtra]){
                                        //if so we will stop the loop and set isValid to false to
                                        //tell the lower code to NOT add it to the extra array and remove it from 
                                        //possible extras
                                        isValid = false;
                                        break;
                                    }
                                }
                                //if we are valid, push it into the extra array and decrease the number we still need
                                if(isValid){
                                    extras.push(possibleExtras[newExtra]);
                                    neededExtras--;
                                }
                                //remove the element whether or not we needed that extra as if it wasn't valid
                                //we don't want to get stuck in an endless loop were the only element is invalid
                                possibleExtras.splice(newExtra, 1);

                            }
                        }
                        //shuffle the extras so the default ones don't always appear first
                        var e2 = [];//stands for extra2, we will put all the extras in here in a random order and then
                        // set extras equal to it and we will never see e2 again
                        while(extras.length > 0){
                            //select a random extra from the extras array
                            var n = Math.floor(Math.random() * extras.length);
                            //and push it to e2
                            e2.push(extras[n]);
                            //then remove it from the original array
                            extras.splice(n, 1);
                        }
                        extras = e2;

                        //We are now going to create the button elements using the extras we have and our answer

                        //the button count is caluclated by the answer button (1) + the number of requested extras - the extras we stil
                        //needed but never got due to insuficent valid extras in the bank. In most cases it should be 0 but
                        //it is possible
                        var buttonCount = 1 + question.NumberOfExtras - neededExtras;
                        //Select a random button to be the answer button, when our buttons are generated its text will
                        //be set to the answer while all the others will pull its text from the extras array
                        var correctButtonNumber = Math.floor(Math.random() * buttonCount);
                        //Save what will be the id of the correct button as the answer so we can check it later
                        //q + cardNumber help identify what card the Quiz object should send the answer to (we can't link the eventListeners
                        //directly to the card's .answer function because 'this' changes to the HTML element and all context of what card
                        //the function belongs to is lost so we send it to Quiz.answer() where we can directly call Quiz.Cards[id].answer()
                        //so we still have the this context)
                        this.answer = "q" + cardNumber + "a" + correctButtonNumber;//the button will send its id as the answer text
                        var eC = 0;//extra count
                        //create all the buttons!
                        for(var i = 0; i < buttonCount;i++){
                            var theButton = document.createElement("input");
                            theButton.classList.add("quiz_button");
                            //check to see if this is the answer button
                            if(i == correctButtonNumber){
                                //if so set it to the answer text
                                theButton.value = question.Answers[0];
                            }else{
                                //if not pick from the extra list and increase the extra counter
                                //the extra counter is used to pick which extra it should be
                                theButton.value = extras[eC];
                                eC++;
                            }
                            //Set the id and type of the button and add the event listener to it
                            // then apend a <br> element before so the button is on a different line than the last one
                            //then add the button to the card element and then save the button in this.inputs for 
                            //future reference
                            theButton.id = "q" + cardNumber + "a" + i;
                            theButton.type = "button";
                            theButton.addEventListener("click", function(){ Quiz.answer(this.id); })
                            this.card.appendChild(document.createElement("br"));
                            this.card.appendChild(theButton);
                            this.inputs.push(theButton);
                        }
                        

                        //Set up the title and other various elements on the card such as hints
                        //load more question settings
                        this.title.innerHTML = question.Text;
                        this.hintText = question.Hint;
                        this.tryHintText = question.TryHint;
                        this.maxAttempts = question.AllowedAttempts;

                        //If there is a hint set, set it up
                        if(this.hintText != ""){
                            this.hint.innerHTML = this.hintText;
                            //if there is a hint delay attatched to the hint
                            //hide it and set up the count down canvas for the animation
                            if(question.HintDelay > 0){
                                this.hint.style.display = "none";
                                this.hintTime = question.HintDelay;
                                this.canvas.width = 30;
                                this.canvas.height =  30;
                                this.card.appendChild(document.createElement("br"));
                                this.card.appendChild(this.canvas);
                            }
                            //append the hint to the card element
                            this.card.appendChild(this.hint);
                        }

                        //a similar process for the tryHint text
                        if(this.tryHintText != ""){
                            this.tryHint.innerHTML = this.tryHintText;
                            this.tryHint.style.display = "none";
                            this.card.appendChild(this.tryHint);
                        }

                        //Cacluate the point values
                        this.pointsPerAnswer = question.PointsPerAnswer;
                        this.possiblePoints = this.pointsPerAnswer;//there is only 1 correct answer in multiple choice questions
                        

                        break;
                    }
                    case("TextEntry"):{
                        //Load the case sensitivity option from the question
                        this.caseSenstive = question.CaseSenstive;
                        
                        //Create the text box element with default place holder text and append it
                        //and save it in this.inputs
                        var theTextBox = document.createElement("input");
                        theTextBox.placeholder = "Enter your answer";
                        theTextBox.type = "text";
                        this.card.appendChild(theTextBox);
                        this.inputs.push(theTextBox);

                        //Copy possible answers from the question to this.answer
                        //Multiple answers can be accepted EX: "Hello" and "Hello!"
                        this.answer = [];
                        question.Answers.forEach(ans=> {
                            this.answer.push(ans);
                        });
                        
                        //Create the check answer button and add event listeners and
                        //save it to this.inputs and add it to the card
                        theButton = document.createElement("input");
                        theButton.id = "q"+cardNumber+"a1";
                        theButton.type = "button";
                        theButton.value="Check Answer";
                        theButton.addEventListener("click",function(){Quiz.answer(this.id);})
                        this.card.appendChild(document.createElement("br"));
                        this.card.appendChild(theButton);
                        this.inputs.push(theButton);

                        //Load settings and set title, hint and try hint text
                        this.title.innerHTML = question.Text;
                        this.hintText = question.Hint;
                        this.tryHintText = question.TryHint;
                        this.maxAttempts = question.AllowedAttempts;

                        if(this.hintText!=""){
                            this.hint.innerHTML = this.hintText;
                            //if there is a hint delay, set up the canvas that will hold the clock animation
                            //and hide the hint
                            if(question.HintDelay>0){
                                this.hint.style.display = "none";
                                this.hintTime = question.HintDelay;
                                this.canvas.width = 30;
                                this.canvas.height=  30;
                                this.card.appendChild(document.createElement("br"));
                                this.card.appendChild(this.canvas);
                            }
                            this.card.appendChild(this.hint);
                        }

                        if(this.tryHintText!=""){
                            this.tryHint.innerHTML = this.tryHintText;
                            this.tryHint.style.display = "none";
                            this.card.appendChild(this.tryHint);
                        }

                        //Calculate the points
                        this.pointsPerAnswer = question.PointsPerAnswer;
                        this.possiblePoints = this.pointsPerAnswer;//there is only 1 correct answer at a time in text questions
                        

                        break;
                    }
                    case("SelectAll"):{
                        //We are going to set up 2 arrays, 1 with the answers, the other with the extras

                        var extras = [];
                        var answers = [];

                        //Pull the answers out of the question data
                        question.Answers.forEach(ans => {
                            answers.push(ans + "");
                        });

                        if(question.Extras.length > 0){//load extras from question
                            for(var i = 0; i < question.Extras.length; i++){
                                extras.push(question.Extras[i]);
                            }
                        }

                        //Pull the needed amount of extras from the bank if needed
                        var neededExtras = 0;

                        if(extras.length < question.NumberOfExtras){
                            //Since we need extras we are going to need a list of all possible ones
                            var possibleExtras = [];
                            //We will use this to loop through the allowed banks for this question
                            var banks = question.Banks;
                            //Calculate how many we need
                            neededExtras = question.NumberOfExtras - extras.length;
                            //Loop through each bank for the question to see if it matches a bank in the Quiz Data
                            //If so, copy all non duplicates to the possible extras array.
                            for(var i = 0; i < Quiz.Banks.length; i++){
                                for(var j = 0; j < banks.length; j++){
                                    if(Quiz.Banks[i].Name == banks[j]){
                                        for(var k = 0; k<  Quiz.Banks[i].Extras.length; k++){
                                            if(!answer.includes(Quiz.Banks[i].Extras[k] + ""))//don't bring in any duplicates of the answers
                                                possibleExtras.push(Quiz.Banks[i].Extras[k]);
                                        }
                                    }
                                }
                            }
                            //Now we are going to keep randomly selecting random extras from Possible extras and add them to our
                            //List of extras we are going to use in the question
                            while(neededExtras > 0 && possibleExtras.length > 0){
                                //Pick a random extra from possibleExtras
                                var newExtra = Math.floor(Math.random() * possibleExtras.length);
                                var isValid = true;
                                //check for duplicates of extras (we only previously
                                //checked for extras that matched one of the answers)
                                //If it does match another one, mark it invalid and remove it from the list
                                 if(extras.includes(possibleExtras[newExtra] + ""))
                                     isValid = false;
                                
                                //If it is valid, add it to the extra list
                                if(isValid){
                                    extras.push(possibleExtras[newExtra]);
                                    neededExtras--;
                                }
                                //Remove the selected item from the list of possible extras
                                possibleExtras.splice(newExtra,1);

                            }
                        }
                        var e2 = [];//shuffle the extras so the default ones don't always appear first
                        while(extras.length > 0){
                            //Select a random index (n) from the extra list and push it to e2 which will be our randomized list
                            var n = Math.floor(Math.random() * extras.length);
                                e2.push(extras[n]);
                                extras.splice(n, 1);
                            }
                        //Extras now is equal to the randomized list
                        extras = e2;

                        //The total number of check boxes. It is equal to the answers + the extras - the extras we 
                        //wanted but for some reason did not get, Like when our question bank was empty
                        var boxCount = question.Answers.length + question.NumberOfExtras - neededExtras;
                        var correctAnswers = [];//the numbers of the boxes that will be correct

                        //We are going to make a list of available boxes to chose from and randomly pick which ones the
                        //correct answers will be in
                        var available = [];
                        for(var i = 0;i<boxCount;i++){
                            available.push(i);
                        }
                        //Select random boxes for the correct answers
                        for(var i = 0; i < question.Answers.length; i++){
                            var n = Math.floor(Math.random() * available.length);
                            correctAnswers.push(available[n]);
                            available.splice(n, 1);
                        }
                        
                        //Shuffle the answers so they don't always apear in the same order
                        //We do this by creating a new array and randomly putting
                        //answers from the answers array and then set the answers array equal to the new array
                        var a2 = [];
                        while(answers.length > 0){
                            var n = Math.floor(Math.random() * answers.length);
                                a2.push(answers[n]);
                                answers.splice(n, 1);
                            }
                        answers = a2;

                        //this.answer will save a true/false array that will be used when checking the for the correct answers
                        //to see which boxes should have been checked.
                        this.answer = [];
                        
                        //We are now going to create the check box elements.
                        //If their ID matches one that was selected for a correct answer, then it is
                        //Filled with text from the answers array, else it is filled with an extra
                        //If it was correct, then we save true to the this.answer array, if not we save false
                        var eC = 0;//extra count to see which extra is next in the list
                        var aC = 0;//answer count to see which answer is next in the list
                        for(var i = 0; i<boxCount;i++){
                            //Create the HTML elements that make up each answer box
                            //The container will hold the check box input and some text
                            var theBox = document.createElement("input");
                            var theText = document.createElement("span");
                            var theContainer = document.createElement("div");
                            //Add the proper classes so they be styling
                            theBox.classList.add("quiz_box");
                            theContainer.classList.add("quiz_box_holder");
                            //Select an extra or an answer to fill the text, and save the choice in this.answer
                            if(correctAnswers.includes(i)){
                                theText.innerHTML = answers[aC];
                                aC++;
                                this.answer.push(true);
                            }else{
                                theText.innerHTML = extras[eC];
                                eC++;
                                this.answer.push(false);
                            }
                            //finish setting up the properties of the element
                            theBox.id = "q"+cardNumber+"a"+i;
                            theBox.type = "checkbox";
                            //And append them to the Card and save the box to this.inputs
                            this.card.appendChild(document.createElement("br"));
                            theContainer.appendChild(theBox);
                            theContainer.appendChild(theText);
                            this.card.appendChild(theContainer);
                            this.inputs.push(theBox);
                        }
                        
                        //Create, append, and save the check answer button.
                        theButton = document.createElement("input");
                        theButton.id = "q"+cardNumber+"a"+this.inputs.length;
                        theButton.type = "button";
                        theButton.value="Check Answer";
                        //It will route to this card's answer function via the Quiz.answer function
                        theButton.addEventListener("click",function(){Quiz.answer(this.id);})
                        this.card.appendChild(document.createElement("br"));
                        this.card.appendChild(theButton);
                        this.inputs.push(theButton);

                        this.title.innerHTML = question.Text;
                        this.hintText = question.Hint;
                        this.tryHintText = question.TryHint;
                        this.maxAttempts = question.AllowedAttempts;
                        this.acceptPartial = question.AcceptPartial;
                        if(this.hintText!=""){
                            this.hint.innerHTML = this.hintText;
                            if(question.HintDelay>0){
                                this.hint.style.display = "none";
                                this.hintTime = question.HintDelay;
                                this.canvas.width = 30;
                                this.canvas.height=  30;
                                this.card.appendChild(document.createElement("br"));
                                this.card.appendChild(this.canvas);
                            }
                            this.card.appendChild(this.hint);
                        }

                        if(this.tryHintText!=""){
                            this.tryHint.innerHTML = this.tryHintText;
                            this.tryHint.style.display = "none";
                            this.card.appendChild(this.tryHint);
                        }
                        this.pointsPerAnswer = question.PointsPerAnswer;
                        this.possiblePoints = this.pointsPerAnswer * aC;

                        break;
                    }
                    default:{
                        alert("Question "+questionId+" has an unrecognized type of "+question.type+".\nPlease contact the creator of the deck.");
                        this.title.innerHTML="Please just hit next question";
                        this.valid = false;
                    }
                }

            }

            var Data = {
                Decks:[],
                FileElement: document.getElementById("FileUpload"),
                DeckSelector: document.getElementById("DeckSelector"),
                LoadDecks(file){
                    var reader = new FileReader();
                    reader.addEventListener("load",Data.UnpackSet);
                    reader.readAsBinaryString(file);
                },
                UnpackSet(event){
                    var info;
                    try{
                        info = JSON.parse(event.target.result);
                        console.log("File JSON data:");
                        console.log(info);
                        if(info.Decks.length == 0){//See if the json returned an array of decks as it should.[deck1,deck2...]
                            throw "No decks were found, empty array was found";
                        }
                        if(!typeof(info.Decks[0].Questions[0].Type)==="String" ){
                            throw "Not a valid Flash Card JSON file";
                        }
                        Data.Decks = info.Decks;//basic tests were passed, if errors happen, they happen. 
                        //Will work on verification Later
                        //TODO
                       Data.DisplaySet();
                    }catch(e){
                        console.log(e);
                        alert("There was a problem reading the file\nPlease be sure this is a Flash Card JSON file (.json)\nError: "+e);
                    }
                },
                DisplaySet(){//Adds the Decks from the Set to the Deck Selection Screen.
                    //Remove all Children from DeckSelector
                    Quiz.SelectedDeck = -1;
                    while(DeckSelector.firstChild){
                        DeckSelector.removeChild(DeckSelector.firstChild);
                    }
                    if(this.Decks.length==0){
                        DeckSelector.innerHTML = "(No Decks Available, try uploading one)*";
                    }
                    for(var i = 0;i<this.Decks.length;i++){
                        var id = "deck"+i;
                        var deckElement = document.createElement("input");
                        deckElement.type = "button";
                        deckElement.value = this.Decks[i].Name;//more verification neededExtras to prevent errors
                        deckElement.title = this.Decks[i].Description;
                        deckElement.id = id;
                        deckElement.addEventListener("click",function(e){
                            if(Quiz.SelectedDeck!=-1){
                                document.getElementById("deck"+Quiz.SelectedDeck).classList.remove("selected");
                            }
                            Quiz.SelectedDeck = parseInt(this.id.slice(4),10);
                            this.classList.add("selected");
                            console.log("Deck "+Quiz.SelectedDeck+" selected");
                        });

                        DeckSelector.appendChild(deckElement);
                    }

                }
            }
            var Quiz = {
                Cards:[],//Holds HTML DIV elements that hold every question in the quiz
                HintTimer:null,
                CurrentCard:-1,
                SelectedDeck:-1,
                TotalCards:-1,
                CardElement:document.getElementById("Card"),
                ScoreElement:document.getElementById("Score"),
                Title:document.getElementById("QuizTitle"),
                QuestionCountElement:document.getElementById("QuestionCount"),
                NextButton:document.getElementById("QuizNext"),
                BackButton:document.getElementById("QuizPrev"),
                EarnedPoints: 0,
                TotalPoints:0,
                Mode:-1,
                Banks:[],//{Bank:"BankName",Extras:[]}
                LoadBanks(){
                    
                    if(this.SelectedDeck == -1){
                        return;//just don't do it!
                    }
                    
                    this.Banks=[];
                    Data.Decks[this.SelectedDeck].ExtraAnswers.forEach(bank => {
                        bank.Extras.forEach(extra=>{this.InsertExtraIntoBank(bank.Bank,extra);})
                    })

                    Data.Decks[this.SelectedDeck].Questions.forEach(question => {
                      
                        if(question.AddAnswerToBank){
                             if((question.Type == "MultipleChoice") || (question.Type == "TextEntry") || (question.Type == "SelectAll" )){
                                
                                question.Banks.forEach(bank => {
                                    this.InsertExtraIntoBank(bank,question.Answers);
                                   
                                });
                            }
                        }
                    });
                },
                InsertExtraIntoBank(Bank,Extra){
                    var bankId = -1;
                    for(var i = 0;i<this.Banks.length;i++){
                        if(this.Banks[i].Name == Bank){
                            bankId = i;
                            break;
                        }
                    }
                    //if the Bank was not found, create a new one
                    if(Array.isArray(Extra)){
                        if(bankId==-1){
                            var newBank = {Name:Bank,Extras:Extra};
                            this.Banks.push(newBank);
                        }else{
                            Extra.forEach(ex => {
                                this.Banks[bankId].Extras.push(ex);
                            });
                            
                        }
                    }else{
                        if(bankId==-1){
                            var newBank = {Name:Bank,Extras:[Extra]};
                            this.Banks.push(newBank);
                        }else{
                            this.Banks[bankId].Extras.push(Extra);
                        }
                    }
                },
                StartQuiz(mode){
                    this.LoadBanks();
                    this.Title.innerHTML=Data.Decks[this.SelectedDeck].Name;
                    //we are going to fill a list with ids so the cards are randomized.
                    while(this.CardElement.firstChild){//so the previous quiz data is cleared out
                        this.CardElement.removeChild(this.CardElement.firstChild);
                    }
                    this.EarnedPoints = 0;
                    this.TotalPoints = 0;
                    this.Cards = [];
                    var CardIds = [];
                    for(var i = 0; i < Data.Decks[this.SelectedDeck].Questions.length; i++){
                        CardIds.push(i);
                    }
                    while(CardIds.length>0){
                        var cardNumber = Math.floor(Math.random()*CardIds.length);//select a random index from CardIds
                        var qId = CardIds[cardNumber];
                        CardIds.splice(cardNumber,1);//remove the ID from the list
                        this.Cards.push(new Card(this.SelectedDeck,qId));
                    }
                    Quiz.CurrentCard = 0;
                    this.Cards[0].show();
                    Quiz.UpdateHud();
                },
                answer(id){//used by the question buttons to redirect the answer to the card's answer function
                    var n = parseInt(id.slice(1,id.length),10);
                    if(isFinite(n)){
                        this.Cards[n].checkAnswer(id);
                    }else{
                        console.log("Error: Invalid Id given for answer: "+id);
                    }
                    Quiz.UpdateHud();

                },
                UpdateHud(){
                    Quiz.QuestionCountElement.innerHTML="Question "+ (Quiz.CurrentCard+1)+" of "+Quiz.Cards.length;
                    var percent = "--";
                    if(Quiz.TotalPoints!=0){
                        percent = Math.floor((Quiz.EarnedPoints / Quiz.TotalPoints) * 100);
                    }
                    Quiz.ScoreElement.innerHTML=percent+"%";
                },
                NextQuestion(){
                    if(Quiz.CurrentCard<Quiz.Cards.length-1){
                        //remove the current card and put up the next one
                        Quiz.CardElement.removeChild(Quiz.Cards[Quiz.CurrentCard].card);
                        Quiz.CurrentCard++;
                        Quiz.Cards[Quiz.CurrentCard].show();
                        Quiz.UpdateHud();
                    }else{
                        alert("Finished");
                        //TODO Go to review screen
                    }
                },
                PreviousQuestion(){
                    if(Quiz.CurrentCard>0){
                        Quiz.CardElement.removeChild(Quiz.Cards[Quiz.CurrentCard].card);
                        Quiz.CurrentCard--;
                        Quiz.Cards[Quiz.CurrentCard].show();
                        Quiz.UpdateHud();
                    }else{
                        alert("How far do you plan to go back?");
                        //TODO 
                    }
                }

                
            }
        </script>
        <script>
            var example = {
    "Name":"The Deck",
    "Description":"Some information about the Deck",
    "ID":100,//randomly assigned to each deck.
    "Date":1000,
    "Creator":"Dr.Awesome4333",
    "Version":[0,0,0,0],
    "Permisions":{
        "Practice":true,
        "Quiz":true,
        "PracticeQuiz":true,
        "Review":true
    },
    "BankNames":["Numbers","Words","Math"],
    "ExtraAnswers":[{"Bank":"Numbers","Extras":[1,2,4]},{"Bank":"Words","Extras":["Walrus","Banana","Extra"]},{"Bank":"Math","Extras":["6\u221A(7))","2+3","\u222B a+c dx"]}],
    "QuestionCount":6,
    "Questions":[
        {
            "Type":"MultipleChoice",
            "Text":"What is 10 + 6?",
            "Answers":[16],
            "PointsPerAnswer":3,
            "Banks":["Numbers"],//if you don't want to use a bank "" is accpeted
            "AddAnswerToBank":true,//Should this answer automatically be added to the bank of extra answers
            "SelectExtrasFromBank":true,//Should the selected bank be used to select extras in addtion to question extras?
            "Extras":["17.6"],//Extra answers that only apply to this question
            "NumberOfExtras":3,//How many extras to show along with the answer
            "HintDelay":10,//amount of time in seconds before the hint button becomes available
            "AllowedAttempts":2,
            "Hint":"It is not 17",// if left empty, no hint will show
            "TryHint":"Not 5 either"//after a failed attempt this hint will show up
        },
        {
            "Type":"MultipleChoice",
            "Text":"What is 10 - 6?",
            "Answers":[4],
            "PointsPerAnswer":3,
            "Banks":["Numbers"],
            "AddAnswerToBank":true,//Should this answer automatically be added to the bank of extra answers
            "SelectExtrasFromBank":true,//Should the selected bank be used to select extras in addtion to question extras?
            "Extras":["-6"],//Extra answers that only apply to this question
            "ShowHint":false,//If true the hint will show by default, if not a button must be clicked to show it after a set amount of time
            "HintDelay":100,//amount of time in seconds before the hint button becomes available
            "AllowedAttempts":2,
            "Hint":"It is not 13",
            "TryHint":"Not 15 either"//after a failed attempt this hint will show up
        },
        {
            "Type":"MultipleChoice",
            "Text":"Click Zombie",
            "Answers":["Zombie"],
            "PointsPerAnswer":3,
            "Banks":["Words"],
            "AddAnswerToBank":true,//Should this answer automatically be added to the bank of extra answers
            "SelectExtrasFromBank":true,//Should the selected bank be used to select extras in addtion to question extras?
            "Extras":["Taco"],//Extra answers that only apply to this question
            "NumberOfExtras":3,//How many extras to show along with the answer
            "HintDelay":0,//amount of time in seconds before the hint button becomes available
            "AllowedAttempts":2,
            "Hint":"",
            "TryHint":"Please read the instructions"//after a failed attempt this hint will show up
        },
        {
            "Type":"MultipleChoice",
            "Text":"Click the \u222B",
            "Answers":["\u222B"],
            "PointsPerAnswer":3,
            "Banks":["Math"],
            "AddAnswerToBank":true,//Should this answer automatically be added to the bank of extra answers
            "SelectExtrasFromBank":true,//Should the selected bank be used to select extras in addtion to question extras?
            "Extras":["He he, Math"],//Extra answers that only apply to this question
            "NumberOfExtras":3,//How many extras to show along with the answer
            "HintDelay":10,//amount of time in seconds before the hint button becomes available
            "AllowedAttempts":1,
            "Hint":"Think super hard",
            "TryHint":"Not 5 either"//after a failed attempt this hint will show up
        },
        {
            "Type":"TextEntry",
            "Text":"Type I love you",
            "Answers":["I love you","I love you.","<3"],
            "PointsPerAnswer":3,
            "CaseSenstive":false,
            "HintDelay":10,//amount of time in seconds before the hint button becomes available
            "AllowedAttempts":2,
            "Hint":"Do you though?",
            "TryHint":"I guess you don't"//after a failed attempt this hint will show up
        },
        {
            "Type":"SelectAll",
            "Text":"Select all words that start with z",
            "Answers":["Zoo","Zang","Zoom"],
            "PointsPerAnswer":1,
            "Banks":["Words"],
            "AddAnswerToBank":true,//Should this answer automatically be added to the bank of extra answers
            "SelectExtrasFromBank":true,//Should the selected bank be used to select extras in addtion to question extras?
            "Extras":["Peanut","Butter","Rocks"],//Extra answers that only apply to this question
            "NumberOfExtras":3,//How many extras to show along with the answer
            "HintDelay":10,//amount of time in seconds before the hint button becomes available
            "AcceptPartial":false,
            "AllowedAttempts":2,
            "Hint":"",
            "TryHint":"Make sure you select ALL the answers!"//after a failed attempt this hint will show up
        }
    ]
}
        </script>
    </body>
</html>